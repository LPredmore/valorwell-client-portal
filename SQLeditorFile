-- UTC-Only Schema Migration
-- This script removes legacy date/time columns and ensures UTC timestamp columns have proper constraints
-- Purpose: Aligns database schema with UTC-only model by removing legacy date columns
-- Execute this script in the Supabase SQL Editor

BEGIN;

-- Step 1: Drop NOT NULL constraints from legacy columns (safety step)
ALTER TABLE appointments
ALTER COLUMN date DROP NOT NULL,
ALTER COLUMN start_time DROP NOT NULL,
ALTER COLUMN end_time DROP NOT NULL;

-- Step 2: Drop legacy columns entirely
ALTER TABLE appointments
DROP COLUMN IF EXISTS date,
DROP COLUMN IF EXISTS start_time,
DROP COLUMN IF EXISTS end_time;

-- Step 3: Ensure UTC timestamp columns have NOT NULL constraints
-- This conditional logic ensures the constraints are added only if they don't already exist
DO $$
BEGIN
    -- Check if start_at is nullable
    IF EXISTS (
        SELECT 1
        FROM information_schema.columns
        WHERE table_name = 'appointments'
        AND column_name = 'start_at'
        AND is_nullable = 'YES'
    ) THEN
        -- Make start_at NOT NULL
        ALTER TABLE appointments
        ALTER COLUMN start_at SET NOT NULL;
    END IF;

    -- Check if end_at is nullable
    IF EXISTS (
        SELECT 1
        FROM information_schema.columns
        WHERE table_name = 'appointments'
        AND column_name = 'end_at'
        AND is_nullable = 'YES'
    ) THEN
        -- Make end_at NOT NULL
        ALTER TABLE appointments
        ALTER COLUMN end_at SET NOT NULL;
    END IF;
END $$;

-- Verification query (commented out - uncomment to run after migration)
-- SELECT column_name, data_type, is_nullable 
-- FROM information_schema.columns 
-- WHERE table_name = 'appointments';

COMMIT;